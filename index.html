<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor de Estudos com Login: Assistente Administrativo Educacional - Arapiraca/AL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A aplicação foi dividida em duas visualizações principais: 'auth-container' (Login/Cadastro) e 'app-container' (Plano de Estudos). O JavaScript controla qual visualização é exibida com base no estado de autenticação do usuário (logado ou não). O progresso, antes salvo no localStorage, agora é sincronizado com o Firebase Firestore. Cada usuário terá seu próprio documento no banco de dados, permitindo que seu progresso seja acessado de qualquer dispositivo. Essa arquitetura com Firebase é a solução padrão da indústria para criar aplicações web modernas e seguras com funcionalidades de usuário. -->
    <!-- Visualization & Content Choices: As visualizações (gráficos, tabelas, modais) da versão anterior foram mantidas. A principal mudança foi no backend: as funções de salvamento foram reescritas para usar o Firestore. Funções como 'getUserProgress' e 'saveUserProgress' agora fazem chamadas assíncronas ao banco de dados para buscar e salvar os dados do usuário logado, garantindo a persistência e sincronização entre dispositivos. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F7F4; }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .nav-link { transition: color 0.3s, border-bottom-color 0.3s; }
        .nav-link:hover, .nav-link.active { color: #D97706; border-bottom-color: #D97706; }
        .checklist-item { cursor: pointer; transition: all 0.2s; }
        .checklist-item.completed { text-decoration: line-through; color: #9CA3AF; background-color: #F3F4F6; }
        .checklist-item:hover { background-color: #FEF3C7; }
        .accordion-button.open svg { transform: rotate(180deg); }
        .modal { display: none; }
        .modal.active { display: flex; }
        .tab-button { transition: all 0.3s; }
        .tab-button.active { background-color: #D97706; color: white; }
        .tab-button:not(.active):hover { background-color: #FBBF24; }
        .quiz-option { cursor: pointer; transition: background-color 0.2s; }
        .quiz-option.answered:not(.correct):not(.incorrect), .quiz-option.simulado-selected { background-color: #E5E7EB; border-color: #9CA3AF;}
        .quiz-option.correct { background-color: #D1FAE5; border-color: #10B981; }
        .quiz-option.incorrect { background-color: #FEE2E2; border-color: #EF4444; }
        #app-container, #loading-spinner { display: none; }
    </style>
</head>
<body class="text-stone-800">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/70 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-amber-600"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-amber-50">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-stone-700 mb-6">Bem-vindo(a)!</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-stone-600 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                </div>
                <div class="mb-2">
                    <label for="login-password" class="block text-sm font-medium text-stone-600 mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                </div>
                <div class="text-right text-sm mb-6">
                    <button type="button" id="forgot-password-btn" class="font-semibold text-amber-600 hover:underline focus:outline-none">Esqueci minha senha</button>
                </div>
                <button type="submit" class="w-full bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition duration-300">Entrar</button>
            </form>
            
            <form id="register-form" class="hidden">
                 <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-stone-600 mb-1">Email</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-stone-600 mb-1">Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                </div>
                <button type="submit" class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-stone-800 transition duration-300">Cadastrar</button>
            </form>

            <form id="reset-form" class="hidden">
                <p class="text-center text-sm text-stone-600 mb-4">Digite seu e-mail e enviaremos um link para você redefinir sua senha.</p>
                <div class="mb-4">
                    <label for="reset-email" class="block text-sm font-medium text-stone-600 mb-1">Email</label>
                    <input type="email" id="reset-email" class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                </div>
                <button type="submit" class="w-full bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition duration-300">Enviar link</button>
            </form>

            <p id="auth-error" class="text-red-500 text-sm text-center mt-4 min-h-[20px]"></p>
            <p class="text-center text-sm text-stone-500 mt-6">
                <span id="toggle-text">Não tem uma conta?</span>
                <button id="toggle-auth-mode" class="font-semibold text-amber-600 hover:underline">Cadastre-se</button>
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container">
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
            <nav class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="text-xl font-bold text-amber-700">Tutor de Estudos</div>
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="#overview" class="nav-link border-b-2 border-transparent pb-1">Visão Geral</a>
                        <a href="#weekly-plan" class="nav-link border-b-2 border-transparent pb-1">Plano Semanal</a>
                        <a href="#simulado-geral" class="nav-link border-b-2 border-transparent pb-1">Simulado Geral</a>
                        <a href="#performance-panel" class="nav-link border-b-2 border-transparent pb-1">Desempenho</a>
                    </div>
                    <div class="flex items-center">
                        <span id="user-email" class="text-sm text-stone-600 mr-4 hidden md:block"></span>
                        <button id="logout-btn" class="bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-md hover:bg-red-600 transition">Sair</button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="container mx-auto px-6 py-12">
             <div class="text-center mb-16">
                <h1 class="text-4xl md:text-5xl font-bold text-amber-800">Concurso SME Arapiraca/AL 2025</h1>
                <p class="mt-2 text-xl text-stone-600">Seu Guia de Preparação para Assistente Administrativo Educacional</p>
            </div>

            <section id="overview" class="mb-20">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Visão Geral da Prova</h2>
                <div class="grid md:grid-cols-5 gap-8 items-center">
                    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-center text-stone-700 mb-4">Peso de Cada Disciplina</h3>
                        <div class="chart-container"><canvas id="examWeightsChart"></canvas></div>
                    </div>
                    <div class="md:col-span-3 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-stone-700 mb-4">Estrutura de Pontuação</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-amber-50">
                                    <tr>
                                        <th class="p-3 font-semibold">Disciplina</th>
                                        <th class="p-3 font-semibold text-center">Questões</th>
                                        <th class="p-3 font-semibold text-center">Pontos/Questão</th>
                                        <th class="p-3 font-semibold text-center">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b"><td class="p-3 font-medium text-amber-800">Conhecimentos Específicos</td><td class="p-3 text-center">20</td><td class="p-3 text-center">3</td><td class="p-3 text-center font-bold">60</td></tr>
                                    <tr class="border-b"><td class="p-3">Português</td><td class="p-3 text-center">10</td><td class="p-3 text-center">2</td><td class="p-3 text-center font-bold">20</td></tr>
                                    <tr class="border-b"><td class="p-3">Informática</td><td class="p-3 text-center">10</td><td class="p-3 text-center">1</td><td class="p-3 text-center font-bold">10</td></tr>
                                    <tr class="border-b"><td class="p-3">Ética</td><td class="p-3 text-center">5</td><td class="p-3 text-center">1</td><td class="p-3 text-center font-bold">5</td></tr>
                                    <tr><td class="p-3">Conhecimentos Gerais</td><td class="p-3 text-center">5</td><td class="p-3 text-center">1</td><td class="p-3 text-center font-bold">5</td></tr>
                                </tbody>
                            </table>
                        </div>
                         <p class="text-xs text-stone-500 mt-4">*Pontuação Mínima: 60 pontos, sem zerar nenhuma disciplina.</p>
                    </div>
                </div>
            </section>

            <section id="weekly-plan" class="mb-20">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Plano Semanal e Materiais</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div id="tabs-container" class="mb-6 flex flex-wrap gap-2"></div>
                    <div id="tabs-content-container"></div>
                </div>
            </section>
            
            <section id="simulado-geral" class="mb-20">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Simulado Geral Completo</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <p class="mb-6 text-stone-600">Teste seus conhecimentos com um simulado completo de 101 questões. Responda a todas as questões e clique em "Finalizar Simulado" no final para ver seu resultado. Suas respostas são salvas automaticamente.</p>
                    <div id="simulado-geral-results" class="mb-6"></div>
                    <div id="simulado-geral-container" class="space-y-6"></div>
                    <div class="mt-8 text-center">
                        <button id="finalize-simulado-btn" class="bg-amber-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-700 transition duration-300">Finalizar Simulado e Ver Resultado</button>
                    </div>
                </div>
            </section>

            <section id="performance-panel" class="mb-20">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Painel de Desempenho</h2>
                <div id="performance-content" class="bg-white p-6 rounded-xl shadow-md"></div>
            </section>
            
             <section id="techniques" class="mb-20">
                 <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Técnicas de Estudo</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-semibold text-stone-700 mb-2">Mapas Mentais</h3><p class="text-sm">Crie diagramas visuais para conectar ideias.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-semibold text-stone-700 mb-2">Flashcards</h3><p class="text-sm">Escreva uma pergunta de um lado e a resposta do outro.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-semibold text-stone-700 mb-2">Técnica Pomodoro</h3><p class="text-sm">Estude por 25 minutos e descanse 5.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-semibold text-stone-700 mb-2">Revisão Ativa</h3><p class="text-sm">Explique o assunto com suas próprias palavras.</p></div>
                </div>
            </section>

            <section id="final-review" class="mb-20">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Reta Final: Últimos 10 Dias</h2>
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <ul class="list-disc list-inside space-y-3">
                        <li>**Dias 10 a 5 (04/12 a 09/12):** Revisão geral.</li>
                        <li>**Dia 4 (10/12):** <button class="modal-trigger font-semibold text-amber-600 hover:underline" data-modal="simulado1">Faça o Simulado Completo 1</button>.</li>
                        <li>**Dia 3 (11/12):** Revise os temas que você mais errou.</li>
                        <li>**Dia 2 (12/12):** <button class="modal-trigger font-semibold text-amber-600 hover:underline" data-modal="simulado2">Faça o Simulado Completo 2</button>.</li>
                        <li>**Véspera (13/12):** Descanse!</li>
                    </ul>
                </div>
            </section>
            
            <section id="syllabus" class="mb-16">
                <h2 class="text-3xl font-bold text-stone-700 mb-8 border-l-4 border-amber-500 pl-4">Conteúdo Programático Completo</h2>
                <div id="accordion-container" class="space-y-4"></div>
            </section>
        </main>
        
        <footer class="bg-stone-100 mt-16 py-6">
            <div class="container mx-auto px-6 text-center text-sm text-stone-500">
                <p>Este plano de estudos é uma ferramenta de apoio baseada no Edital N° 02/2025.</p>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="modals-container"></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfG-3SV8Tkczas4cGcIQwv5atFZVcDKFs",
      authDomain: "tutor-estudos.firebaseapp.com",
      projectId: "tutor-estudos",
      storageBucket: "tutor-estudos.appspot.com",
      messagingSenderId: "691817799067",
      appId: "1:691817799067:web:090572d64ffc44aa5dd53e"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Erro ao inicializar o Firebase. Verifique suas chaves de configuração (firebaseConfig).", e);
        alert("ERRO DE CONFIGURAÇÃO: Não foi possível conectar ao Firebase. Verifique se as chaves em 'firebaseConfig' estão corretas.");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    const studyData = {
        simuladoGeral: {
            title: 'Simulado Geral Completo',
            questions: [
                // Conhecimentos Específicos (40 questões)
                { q: "[Específicos] Qual ato administrativo de efeito interno serve para expedir ordens e determinações a subordinados?", options: ["Decreto", "Portaria", "Ofício", "Circular"], answer: "Portaria" },
                { q: "[Específicos] A fase do ciclo de vida dos documentos onde eles são frequentemente consultados é a fase:", options: ["Corrente", "Intermediária", "Permanente", "Histórica"], answer: "Corrente" },
                { q: "[Específicos] O ato de juntar um processo a outro, de forma definitiva, por terem o mesmo interessado ou assunto, chama-se:", options: ["Apensação", "Anexação", "Desmembramento", "Autuação"], answer: "Anexação" },
                { q: "[Específicos] O método de controle de estoque que visa manter a quantidade mínima de um item para evitar faltas é o:", options: ["Estoque Máximo", "Estoque de Segurança", "Ponto de Pedido", "Lote Econômico"], answer: "Estoque de Segurança" },
                { q: "[Específicos] Segundo a Lei Orgânica de Arapiraca, o Poder Legislativo é exercido pela:", options: ["Prefeitura Municipal", "Câmara Municipal", "Secretaria de Educação", "Assembleia Legislativa"], answer: "Câmara Municipal" },
                { q: "[Específicos] A formalização de um processo, com capa e numeração de páginas, é chamada de:", options: ["Protocolo", "Tramitação", "Arquivamento", "Autuação"], answer: "Autuação" },
                { q: "[Específicos] Qual princípio da administração pública NÃO está expresso no art. 37 da Constituição (LIMPE)?", options: ["Legalidade", "Razoabilidade", "Moralidade", "Eficiência"], answer: "Razoabilidade" },
                { q: "[Específicos] A comunicação oficial entre órgãos da mesma esfera de poder é feita, preferencialmente, por:", options: ["Carta", "Memorando", "Ofício", "E-mail"], answer: "Ofício" },
                { q: "[Específicos] O que é a Tabela de Temporalidade de Documentos?", options: ["Um calendário de feriados", "Uma lista de preços de materiais", "Um instrumento que define por quanto tempo os documentos devem ser guardados", "Um organograma da prefeitura"], answer: "Um instrumento que define por quanto tempo os documentos devem ser guardados" },
                { q: "[Específicos] O atendimento ao público com cortesia, presteza e urbanidade é um dever do servidor que se relaciona com qual princípio?", options: ["Legalidade", "Eficiência", "Moralidade", "Publicidade"], answer: "Eficiência" },
                // Adicione mais 30 questões de Específicos...
                { q: "[Específicos] O ato de registrar a entrada de um documento na instituição é função do:", options: ["Arquivo", "Protocolo", "Almoxarifado", "Recursos Humanos"], answer: "Protocolo" },
                { q: "[Específicos] A classificação de um documento como 'ostensivo' significa que ele é:", options: ["Secreto", "De acesso público", "Urgente", "Pessoal"], answer: "De acesso público" },
                { q: "[Específicos] Qual documento formaliza decisões de colegiados, como conselhos e comissões?", options: ["Ata", "Relatório", "Parecer", "Portaria"], answer: "Ata" },
                { q: "[Específicos] O descarte de documentos públicos sem autorização legal pode configurar:", options: ["Ato de improbidade", "Crime contra a administração", "Ambos", "Apenas uma infração administrativa"], answer: "Ambos" },
                { q: "[Específicos] O que significa a sigla PEPS em gestão de estoques?", options: ["Primeiro que Entra, Primeiro que Sai", "Preço Estimado Ponderado de Saída", "Pedido Especial para Suprimentos", "Ponto de Encomenda Padrão de Segurança"], answer: "Primeiro que Entra, Primeiro que Sai" },
                ...Array(25).fill(0).map((_, i) => ({ q: `[Específicos] Pergunta Específica Placeholder ${i+1}`, options: ["Opção A", "Opção B", "Opção C", "Resposta Correta"], answer: "Resposta Correta" })),

                // Português (20 questões)
                { q: "[Português] 'Entregou o documento ___ diretora.' A lacuna deve ser preenchida com:", options: ["a", "à", "á", "há"], answer: "à" },
                { q: "[Português] Na frase 'Choveu muito ontem', o sujeito é:", options: ["Simples", "Composto", "Indeterminado", "Inexistente"], answer: "Inexistente" },
                { q: "[Português] Assinale a palavra que NÃO é acentuada pela mesma regra das demais.", options: ["Análise", "Lâmpada", "Último", "Caráter"], answer: "Caráter" },
                { q: "[Português] 'O funcionário que trabalha bem é elogiado.' A oração 'que trabalha bem' é uma oração subordinada:", options: ["Adjetiva Restritiva", "Adjetiva Explicativa", "Adverbial Causal", "Substantiva Objetiva Direta"], answer: "Adjetiva Restritiva" },
                { q: "[Português] Qual a forma verbal correta para 'Se eu ___ o documento, te aviso'?", options: ["ver", "vir", "visse", "verei"], answer: "vir" },
                ...Array(15).fill(0).map((_, i) => ({ q: `[Português] Pergunta Português Placeholder ${i+1}`, options: ["Opção A", "Resposta Correta", "Opção C", "Opção D"], answer: "Resposta Correta" })),

                // Informática (20 questões)
                { q: "[Informática] Qual atalho no Windows serve para alternar entre janelas abertas?", options: ["Alt + F4", "Ctrl + C", "Alt + Tab", "Ctrl + Tab"], answer: "Alt + Tab" },
                { q: "[Informática] No Excel, para somar os valores das células de A1 até A10, qual fórmula é usada?", options: ["=SOMA(A1:A10)", "=TOTAL(A1-A10)", "=SOMAR(A1..A10)", "=CALC(A1+A10)"], answer: "=SOMA(A1:A10)" },
                { q: "[Informática] Um 'firewall' serve para:", options: ["Proteger o computador contra vírus", "Acelerar a conexão com a internet", "Filtrar o tráfego de rede, bloqueando acessos não autorizados", "Fazer cópias de segurança dos arquivos"], answer: "Filtrar o tráfego de rede, bloqueando acessos não autorizados" },
                { q: "[Informática] Qual dos seguintes é um exemplo de software livre?", options: ["Microsoft Windows", "Adobe Photoshop", "Linux", "Microsoft Office"], answer: "Linux" },
                { q: "[Informática] O que significa 'computação em nuvem'?", options: ["Armazenar arquivos em um HD externo", "Usar programas e arquivos salvos em servidores na internet", "Aumentar a memória RAM do computador", "Proteger o PC contra chuvas"], answer: "Usar programas e arquivos salvos em servidores na internet" },
                ...Array(15).fill(0).map((_, i) => ({ q: `[Informática] Pergunta Informática Placeholder ${i+1}`, options: ["Resposta Correta", "Opção B", "Opção C", "Opção D"], answer: "Resposta Correta" })),
                
                // Ética (10 questões)
                { q: "[Ética] Receber um presente de valor de uma empresa que tem contrato com a prefeitura pode ferir o princípio da:", options: ["Legalidade", "Publicidade", "Moralidade", "Eficiência"], answer: "Moralidade" },
                { q: "[Ética] De acordo com a LAI (Lei de Acesso à Informação), a regra é:", options: ["O sigilo da informação", "A publicidade da informação", "O acesso restrito aos gestores", "A cobrança pelo acesso"], answer: "A publicidade da informação" },
                { q: "[Ética] Um servidor que se recusa a prestar informações ao cidadão, sem justificativa legal, comete um ato que fere seus:", options: ["Direitos", "Deveres", "Benefícios", "Privilégios"], answer: "Deveres" },
                ...Array(7).fill(0).map((_, i) => ({ q: `[Ética] Pergunta Ética Placeholder ${i+1}`, options: ["Opção A", "Opção B", "Resposta Correta", "Opção D"], answer: "Resposta Correta" })),
                
                // Conhecimentos Gerais (11 questões)
                { q: "[Gerais] Arapiraca é frequentemente chamada de 'Capital do Agreste' e também de 'Capital do':", options: ["Algodão", "Fumo", "Milho", "Café"], answer: "Fumo" },
                { q: "[Gerais] O fundador de Arapiraca, que se estabeleceu na região e deu origem à cidade, foi:", options: ["Manoel André", "Graciliano Ramos", "Aurélio Buarque", "Teotônio Vilela"], answer: "Manoel André" },
                { q: "[Gerais] A Lei maior que rege o município de Arapiraca é:", options: ["O Código de Posturas", "A Constituição Estadual", "O Plano Diretor", "A Lei Orgânica Municipal"], answer: "A Lei Orgânica Municipal" },
                ...Array(8).fill(0).map((_, i) => ({ q: `[Gerais] Pergunta Gerais Placeholder ${i+1}`, options: ["Opção A", "Resposta Correta", "Opção C", "Opção D"], answer: "Resposta Correta" })),
            ]
        },
        summaries: {'s1-especificos': { title: 'Resumo: Princípios da Administração Pública (LIMPE)', content: ``},'s1-portugues': { title: 'Resumo: Crase - Regras Essenciais', content: ``},'s2-especificos': { title: 'Resumo: Gestão de Documentos - Protocolo', content: ``},'s2-portugues': { title: 'Resumo: Concordância Verbal', content: ``},'s3-especificos': { title: 'Resumo: Arquivamento', content: ``},'s3-etica': { title: 'Resumo: Lei de Improbidade Administrativa', content: ``},}, 
        quizzes: {'q1': { title: 'Exercícios da Semana 1', questions: [{ q: "[Específicos] O princípio que proíbe a promoção pessoal do administrador com atos do governo é o da:", options: ["Moralidade", "Legalidade", "Publicidade", "Impessoalidade"], answer: "Impessoalidade" }, { q: "[Português] Qual frase usa a crase incorretamente?", options: ["Entreguei o prêmio àquela aluna.", "Fomos à uma boa festa.", "A reunião será às três horas.", "Estou à disposição."], answer: "Fomos à uma boa festa." }, { q: "[Informática] Qual dos seguintes é um Sistema Operacional?", options: ["Microsoft Excel", "Google Chrome", "Windows 11", "Adobe Photoshop"], answer: "Windows 11" }] },'q2': { title: 'Exercícios da Semana 2', questions: [{ q: "[Específicos] O registro de um documento em um sistema, com número único, é chamado de:", options: ["Tramitação", "Distribuição", "Registro", "Arquivamento"], answer: "Registro" }, { q: "[Português] Assinale a concordância verbal CORRETA:", options: ["Houveram muitos acidentes.", "Fazem cinco anos que moro aqui.", "Existe poucas vagas.", "A maioria dos alunos passou."], answer: "A maioria dos alunos passou." }, { q: "[Informática] Uma fórmula no Excel deve sempre começar com qual símbolo?", options: ["@", "#", "=", "&"], answer: "=" }] },'q3': { title: 'Exercícios da Semana 3', questions: [{ q: "[Específicos] Guardar processos por número de matrícula é um método de arquivamento:", options: ["Alfabético", "Geográfico", "Numérico", "Por assunto"], answer: "Numérico" }, { q: "[Ética] Realizar uma compra pública com preço muito acima do mercado pode configurar, segundo a Lei de Improbidade:", options: ["Enriquecimento Ilícito", "Prejuízo ao Erário", "Ato contra os princípios", "Nenhuma das alternativas"], answer: "Prejuízo ao Erário" }] },'sp1': { title: 'Simulado Parcial 1 (Semanas 1-4)', questions: [{q:"[Específicos] Qual princípio do LIMPE se relaciona com a busca por resultados e economia de recursos?", options:["Legalidade","Impessoalidade","Moralidade","Eficiência"], answer:"Eficiência"},{q:"[Português] Em 'Referi-me ___ aluna que chegou', qual a forma correta?", options:["a","à","á","ah"], answer:"à"},{q:"[Informática] Para salvar um documento no Word com um novo nome, usa-se:", options:["CTRL+B","CTRL+G","Salvar Como","Salvar"], answer:"Salvar Como"},{q:"[Ética] A Lei de Acesso à Informação (LAI) estabelece que a regra é:", options:["O sigilo","A publicidade","O acesso restrito","A burocracia"], answer:"A publicidade"},{q:"[Gerais] A base econômica histórica de Arapiraca é a cultura do:", options:["Milho","Fumo","Algodão","Café"], answer:"Fumo"}]},'sp2': { title: 'Simulado Parcial 2 (Semanas 5-8)', questions: [{q:"[Específicos] O controle de entrada e saída de itens de um depósito é chamado de:", options:["Gestão de Pessoas","Gestão de Estoques","Gestão de Protocolo","Gestão Financeira"], answer:"Gestão de Estoques"},{q:"[Português] 'Quando eu o ___, avisarei.' Complete com o verbo VER no futuro do subjuntivo.", options:["ver","vir","visse","verei"], answer:"vir"},{q:"[Informática] Um ataque que tenta enganar você para roubar senhas é chamado de:", options:["Firewall","Backup","Phishing","Antivírus"], answer:"Phishing"}]},}, 
        simulados: {'simulado1': { title: 'Simulado Completo 1', questions: [] },'simulado2': { title: 'Simulado Completo 2', questions: [] }}, 
        weeklyPlan: [{ week: 1, goal: "Construir a base em Conhecimentos Específicos e Português.", schedule: [{ day: "Seg", topics: "Específicos: Princípios da Adm. Pública / Português: Interpretação de Texto" },{ day: "Ter", topics: "Português: Crase / Informática: Windows e Word" },{ day: "Qua", topics: "Específicos: Atendimento ao Público e Redação Oficial" },{ day: "Qui", topics: "Ética: Princípios do Serviço Público / Gerais: História de Arapiraca" },{ day: "Sex", topics: "Revisão e exercícios" }], materials: [{ label: "Resumo: Princípios da Adm. Pública (LIMPE)", modal: "s1-especificos" },{ label: "Resumo: Crase - Regras Essenciais", modal: "s1-portugues" }], quiz: "q1" },{ week: 2, goal: "Avançar em Gestão de Documentos e Informática (Excel).", schedule: [], materials: [], quiz: "q2" },{ week: 3, goal: "Foco em Arquivamento e Leis de Ética (Improbidade).", schedule: [], materials: [], quiz: "q3" },{ week: 4, goal: "Revisão do primeiro mês e Processos Administrativos.", schedule: [], materials: [], quiz: "sp1" },{ week: 5, goal: "Iniciar Gestão de Materiais e Sintaxe do Período Composto.", schedule: [], materials: [], quiz: "" },{ week: 6, goal: "Aprofundar na Lei Orgânica e Segurança da Informação.", schedule: [], materials: [], quiz: "" },{ week: 7, goal: "Foco em Redes de Computadores e resolução de questões.", schedule: [], materials: [], quiz: "" },{ week: 8, goal: "Revisão do segundo mês e simulado parcial.", schedule: [], materials: [], quiz: "sp2" },{ week: 9, goal: "Cobrir últimos tópicos e revisar pontos fracos.", schedule: [], materials: [], quiz: "" },{ week: 10, goal: "Revisão geral antes da Reta Final.", schedule: [], materials: [], quiz: "" },]
    };
    const syllabusData = {'Conhecimentos Específicos':['Informações gerais sobre o Município','Lei Orgânica do Município','Plano de cargos e carreiras','Atos administrativos','Documentação e Arquivo','Funções de protocolo','Gestão de materiais e estoques','Processos administrativos'],'Português':['Leitura e compreensão de textos','Modos de organização do discurso','Gêneros do discurso','Coesão e coerência','Relação entre as partes do texto','Conectivos','Verbos, Pronomes, Figuras de linguagem','Sinônimos, antônimos, etc.','Acentuação e Pontuação','Sintaxe','Crase e Ortografia'],'Informática':['Arquitetura de Computadores','Software','Windows 10/11 e Linux','MS Office, LibreOffice','Microsoft 365 e Teams','Segurança da Informação','Redes de Computadores','Internet e Web','Redes Sociais e Nuvem','Ferramentas Google'],'Ética':['Conceitos de Ética e Moral','Ética e Vida Pública','Conduta ética no serviço público','Deveres e vedações','Legislação aplicada à ética','Ética, Integridade e Cidadania','Estatutos municipais'],'Conhecimentos Gerais':['História de Arapiraca','Aspectos geográficos e sociais','Patrimônio cultural','Estrutura da Prefeitura','Lei Orgânica','Bandeira e hino']};
    
    // UI Elements
    const loadingSpinner = document.getElementById('loading-spinner');
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const resetForm = document.getElementById('reset-form');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
    const authError = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailSpan = document.getElementById('user-email');

    let currentUser = null;
    let userProgress = {};

    // --- Firebase Auth & Firestore Logic ---
    auth.onAuthStateChanged(async user => {
        loadingSpinner.style.display = 'flex';
        if (user) {
            currentUser = user;
            await loadUserProgress();
            initializeAppUI();
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
        } else {
            currentUser = null;
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }
        loadingSpinner.style.display = 'none';
    });
    
    async function loadUserProgress() {
        if (!currentUser) return;
        const docRef = db.collection('users').doc(currentUser.uid);
        const doc = await docRef.get();
        if (doc.exists) {
            userProgress = doc.data();
        } else {
            userProgress = { checklist: {}, quizResults: {} };
        }
    }
    
    async function saveUserProgress() {
        if (!currentUser) return;
        // Debounce save operation to avoid too many writes
        if (window.saveTimeout) clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(async () => {
            await db.collection('users').doc(currentUser.uid).set(userProgress);
        }, 1000);
    }
    
    function getFirebaseErrorMessage(errorCode) {
        switch (errorCode) {
            case 'auth/wrong-password': case 'auth/user-not-found': case 'auth/invalid-credential':
                return 'E-mail ou senha incorretos. Tente novamente.';
            case 'auth/invalid-email': return 'O formato do e-mail é inválido.';
            case 'auth/email-already-in-use': return 'Este e-mail já está cadastrado.';
            case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
            default: return 'Ocorreu um erro. Verifique sua conexão ou tente novamente.';
        }
    }

    loginForm.addEventListener('submit', e => { e.preventDefault(); authError.textContent = ''; auth.signInWithEmailAndPassword(loginForm['login-email'].value, loginForm['login-password'].value).catch(error => { authError.textContent = getFirebaseErrorMessage(error.code); }); });
    registerForm.addEventListener('submit', e => { e.preventDefault(); authError.textContent = ''; auth.createUserWithEmailAndPassword(registerForm['register-email'].value, registerForm['register-password'].value).catch(error => { authError.textContent = getFirebaseErrorMessage(error.code); }); });
    resetForm.addEventListener('submit', e => { e.preventDefault(); authError.textContent = ''; auth.sendPasswordResetEmail(resetForm['reset-email'].value).then(() => { authError.textContent = 'Link enviado! Verifique sua caixa de entrada e spam.'; authError.classList.remove('text-red-500'); authError.classList.add('text-green-600'); }).catch((error) => { authError.textContent = getFirebaseErrorMessage(error.code); authError.classList.add('text-red-500'); authError.classList.remove('text-green-600'); }); });
    logoutBtn.addEventListener('click', () => { auth.signOut(); });

    forgotPasswordBtn.addEventListener('click', () => {
        loginForm.classList.add('hidden');
        registerForm.classList.add('hidden');
        resetForm.classList.remove('hidden');
        document.getElementById('auth-title').textContent = 'Redefinir Senha';
        document.getElementById('toggle-text').textContent = '';
        toggleAuthModeBtn.textContent = 'Voltar para o Login';
        authError.textContent = '';
    });

    toggleAuthModeBtn.addEventListener('click', () => {
        const isResetActive = !resetForm.classList.contains('hidden');
        authError.textContent = '';
        authError.classList.remove('text-green-600');
        authError.classList.add('text-red-500');

        if (isResetActive) {
            resetForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Bem-vindo(a)!';
            document.getElementById('toggle-text').textContent = 'Não tem uma conta?';
            toggleAuthModeBtn.textContent = 'Cadastre-se';
        } else {
            const isLoginActive = !loginForm.classList.contains('hidden');
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            document.getElementById('auth-title').textContent = isLoginActive ? 'Crie sua Conta' : 'Bem-vindo(a)!';
            document.getElementById('toggle-text').textContent = isLoginActive ? 'Já tem uma conta?' : 'Não tem uma conta?';
            toggleAuthModeBtn.textContent = isLoginActive ? 'Entrar' : 'Cadastre-se';
        }
    });

    // --- App Initialization & Rendering ---
    function initializeAppUI() {
        if (!currentUser) return;
        userEmailSpan.textContent = currentUser.email;
        renderChart();
        renderWeeklyPlan();
        renderModals();
        renderSyllabus();
        renderSimuladoGeral();
        loadSimuladoGeralState();
        loadChecklistState();
        updatePerformancePanel();
    }
    
    function renderChart() {
        const chartElement = document.getElementById('examWeightsChart');
        if (Chart.getChart(chartElement)) Chart.getChart(chartElement).destroy();
        new Chart(chartElement.getContext('2d'), { type: 'doughnut', data: { labels: ['Específicos', 'Português', 'Informática', 'Ética', 'Gerais'], datasets: [{ data: [60, 20, 10, 5, 5], backgroundColor: ['#92400E', '#B45309', '#D97706', '#F59E0B', '#FBBF24'], borderColor: '#F8F7F4', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed}%` } } } } });
    }
    
    function renderWeeklyPlan() {
        const tabsContainer = document.getElementById('tabs-container');
        const contentContainer = document.getElementById('tabs-content-container');
        tabsContainer.innerHTML = studyData.weeklyPlan.map((w, i) => `<button class="tab-button px-4 py-2 rounded-md font-semibold ${i === 0 ? 'active' : ''}" data-target="week-${w.week}">Semana ${w.week}</button>`).join('');
        contentContainer.innerHTML = studyData.weeklyPlan.map((w, i) => `<div id="week-${w.week}" class="tab-content ${i > 0 ? 'hidden' : ''}"><h3 class="text-xl font-bold text-stone-700">${w.goal}</h3><div class="mt-4 space-y-2">${w.schedule.map(s => `<p><strong>${s.day}:</strong> ${s.topics}</p>`).join('')}</div>${w.materials.length > 0 ? `<h4 class="font-semibold mb-2 mt-4">Materiais:</h4>${w.materials.map(m => `<button class="modal-trigger text-amber-600 hover:underline" data-modal="${m.modal}">${m.label}</button>`).join('<br>')}` : ''}${w.quiz ? `<div class="mt-4"><button class="modal-trigger bg-amber-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-amber-700" data-modal="${w.quiz}">Exercícios</button></div>` : ''}</div>`).join('');
        tabsContainer.addEventListener('click', e => { if (e.target.classList.contains('tab-button')) { tabsContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); contentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(e.target.dataset.target).classList.remove('hidden'); } });
    }

    function renderSyllabus() {
        const accordionContainer = document.getElementById('accordion-container');
        accordionContainer.innerHTML = Object.keys(syllabusData).map(subject => `<div class="bg-white rounded-xl shadow-md overflow-hidden"><button class="accordion-button w-full flex justify-between items-center p-5 text-left font-semibold text-stone-700 hover:bg-amber-50 focus:outline-none"><span>${subject}</span><svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content hidden p-5 border-t border-stone-200"><ul class="space-y-2">${syllabusData[subject].map(topic => `<li class="checklist-item p-2 rounded-md" data-topic="${subject.replace(/\s/g, '-')}-${topic.replace(/\s/g, '-')}">${topic}</li>`).join('')}</ul></div></div>`).join('');
        accordionContainer.addEventListener('click', e => { if (e.target.closest('.accordion-button')) { const button = e.target.closest('.accordion-button'); button.classList.toggle('open'); button.nextElementSibling.classList.toggle('hidden'); } if (e.target.classList.contains('checklist-item')) { e.target.classList.toggle('completed'); saveChecklistState(e.target); } });
    }

    function renderModals() {
        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = '';
        const allModalData = { ...studyData.summaries, ...studyData.quizzes, ...studyData.simulados, ...studyData.simuladoGeral };
        Object.keys(allModalData).forEach(key => {
            const data = allModalData[key];
            if (!data || !data.title) return;
            const modal = document.createElement('div');
            modal.id = key;
            modal.className = 'modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50';
            let contentHtml = data.questions ? data.questions.map((q, i) => `<div class="quiz-item mb-4" data-quiz-id="${key}" data-question-index="${i}"><p class="font-semibold">${i + 1}. ${q.q}</p><div class="space-y-2 mt-2">${q.options.map(opt => `<div class="quiz-option border-2 border-stone-200 p-2 rounded-md" data-answer="${q.answer}">${opt}</div>`).join('')}</div><p class="quiz-feedback hidden mt-2 text-sm"></p></div>`).join('') : data.content;
            modal.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-bold">${data.title}</h3><button class="modal-close text-2xl">&times;</button></div><div class="p-6 overflow-y-auto">${contentHtml}</div></div>`;
            modalsContainer.appendChild(modal);
        });
    }
    
    function renderSimuladoGeral() {
        const container = document.getElementById('simulado-geral-container');
        container.innerHTML = studyData.simuladoGeral.questions.map((q, i) => `
            <div class="quiz-item border-t pt-4" data-quiz-id="simuladoGeral" data-question-index="${i}">
                <p class="font-semibold">${i + 1}. ${q.q}</p>
                <div class="grid sm:grid-cols-2 gap-2 mt-2">
                    ${q.options.map(opt => `<div class="quiz-option border-2 border-stone-200 p-2 rounded-md">${opt}</div>`).join('')}
                </div>
            </div>`).join('');
    }

    // --- State Management & Event Handlers ---
    function loadChecklistState() {
        const completed = userProgress.checklist || {};
        document.querySelectorAll('.checklist-item').forEach(item => { if (completed[item.dataset.topic]) item.classList.add('completed'); else item.classList.remove('completed'); });
    }
    function saveChecklistState(item) {
        if (!userProgress.checklist) userProgress.checklist = {};
        userProgress.checklist[item.dataset.topic] = item.classList.contains('completed');
        saveUserProgress();
    }
    
    function updatePerformancePanel() {
        const results = userProgress.quizResults || {};
        const panel = document.getElementById('performance-content');
        if (Object.keys(results).length === 0) { panel.innerHTML = '<p>Responda aos exercícios e simulados para ver seu desempenho aqui.</p>'; return; }
        let totalCorrect = 0, totalAnswered = 0;
        const subjectStats = {}, wrongAnswers = {};
        const allQuizzes = { ...studyData.quizzes, ...studyData.simulados, simuladoGeral: studyData.simuladoGeral };

        for (const quizId in results) {
            const quizData = allQuizzes[quizId];
            if (!quizData) continue;
            for (const qIndex in results[quizId]) {
                if (results[quizId][qIndex].finalized) continue; // Skip finalized simuladoGeral
                const result = results[quizId][qIndex];
                totalAnswered++;
                const questionData = quizData.questions[qIndex];
                const subject = (questionData.q.match(/^\[(.*?)\]/) || [])[1] || 'Geral';
                if (!subjectStats[subject]) subjectStats[subject] = { correct: 0, total: 0 };
                subjectStats[subject].total++;
                if (result.isCorrect) { totalCorrect++; subjectStats[subject].correct++; }
            }
        }
        const overallPercentage = totalAnswered > 0 ? ((totalCorrect / totalAnswered) * 100).toFixed(0) : 0;
        panel.innerHTML = `<div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="bg-amber-50 p-4 rounded-lg text-center"><p class="text-sm">Acerto Geral (Exercícios)</p><p class="text-2xl font-bold">${overallPercentage}%</p></div>
            <div class="bg-amber-50 p-4 rounded-lg text-center"><p class="text-sm">Questões de Exercícios</p><p class="text-2xl font-bold">${totalAnswered}</p></div>
        </div>
        <h4 class="font-semibold mb-2">Desempenho por Disciplina (Exercícios):</h4>
        <div class="space-y-2">${Object.keys(subjectStats).sort().map(s => `<div class="flex justify-between items-center"><p>${s}</p><p class="font-semibold">${subjectStats[s].total > 0 ? ((subjectStats[s].correct / subjectStats[s].total) * 100).toFixed(0) : 0}%</p></div>`).join('')}</div>`;
    }

    function loadQuizState(modal) {
        modal.querySelectorAll('.quiz-item').forEach(item => {
            const quizId = item.dataset.quizId;
            const qIndex = item.dataset.questionIndex;
            const results = userProgress.quizResults || {};
            item.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('answered', 'correct', 'incorrect'));
            item.querySelector('.quiz-feedback')?.classList.add('hidden');
            if (results[quizId] && results[quizId][qIndex] && !results[quizId].finalized) {
                const { userAnswer, isCorrect } = results[quizId][qIndex];
                item.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.add('answered');
                    if(opt.textContent === userAnswer) opt.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if(opt.textContent === studyData.quizzes[quizId].questions[qIndex].answer && !isCorrect) opt.classList.add('correct');
                });
                const feedback = item.querySelector('.quiz-feedback');
                feedback.textContent = isCorrect ? 'Resposta Correta!' : `Incorreto. A resposta certa é: ${studyData.quizzes[quizId].questions[qIndex].answer}`;
                feedback.className = `quiz-feedback block mt-2 text-sm ${isCorrect ? 'text-green-600' : 'text-red-600'}`;
            }
        });
    }

    function loadSimuladoGeralState() {
        const resultsContainer = document.getElementById('simulado-geral-results');
        const questionsContainer = document.getElementById('simulado-geral-container');
        const finalizeBtn = document.getElementById('finalize-simulado-btn');
        const results = userProgress.quizResults?.simuladoGeral || {};

        if (results.finalized) {
            finalizeSimuladoGeral(true); // show results, don't re-calculate
            return;
        }

        questionsContainer.querySelectorAll('.quiz-item').forEach(item => {
            const qIndex = item.dataset.questionIndex;
            if (results[qIndex]) {
                const { userAnswer } = results[qIndex];
                item.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('simulado-selected');
                    if (opt.textContent === userAnswer) {
                        opt.classList.add('simulado-selected');
                    }
                });
            }
        });
    }

    function finalizeSimuladoGeral(isReload = false) {
        const resultsContainer = document.getElementById('simulado-geral-results');
        const questionsContainer = document.getElementById('simulado-geral-container');
        const finalizeBtn = document.getElementById('finalize-simulado-btn');
        const results = userProgress.quizResults?.simuladoGeral || {};
        
        let correctCount = 0;
        const wrongAnswers = [];
        const totalQuestions = studyData.simuladoGeral.questions.length;
        
        if (!isReload) {
            if (!userProgress.quizResults) userProgress.quizResults = {};
            userProgress.quizResults.simuladoGeral = userProgress.quizResults.simuladoGeral || {};
            userProgress.quizResults.simuladoGeral.finalized = true;
            saveUserProgress();
        }

        studyData.simuladoGeral.questions.forEach((q, i) => {
            const userAnswer = results[i]?.userAnswer;
            if (userAnswer === q.answer) {
                correctCount++;
            } else if (userAnswer) {
                wrongAnswers.push({ question: q.q, yourAnswer: userAnswer, correctAnswer: q.answer });
            }
        });

        const score = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : 0;
        resultsContainer.innerHTML = `
            <div class="bg-amber-50 p-6 rounded-lg text-center">
                <h3 class="text-xl font-bold text-stone-800">Resultado do Simulado</h3>
                <p class="text-4xl font-bold my-2">${score}%</p>
                <p class="text-stone-600">${correctCount} de ${totalQuestions} questões corretas.</p>
                ${wrongAnswers.length > 0 ? `<div class="text-left mt-4"><h4 class="font-semibold mb-2">Revise seus erros:</h4><ul class="list-disc list-inside space-y-2 text-sm">${wrongAnswers.map(wa => `<li>${wa.question} <br><i>(Sua resposta: ${wa.yourAnswer} | Correta: ${wa.correctAnswer})</i></li>`).join('')}</ul></div>` : ''}
            </div>`;
        
        questionsContainer.style.display = 'none';
        finalizeBtn.style.display = 'none';
    }

    document.getElementById('finalize-simulado-btn').addEventListener('click', () => {
        if (confirm('Tem certeza que deseja finalizar o simulado? Você não poderá alterar suas respostas depois.')) {
            finalizeSimuladoGeral();
        }
    });
    
    document.body.addEventListener('click', async e => {
        if (e.target.classList.contains('modal-trigger')) {
            const modalId = e.target.dataset.modal;
            const modal = document.getElementById(modalId);
            if (modal) { modal.classList.add('active'); if (modal.querySelector('.quiz-item')) loadQuizState(modal); }
        }
        if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal')) {
            e.target.closest('.modal')?.classList.remove('active');
        }
        
        const quizItem = e.target.closest('.quiz-item');
        if (quizItem && e.target.classList.contains('quiz-option')) {
            const quizId = quizItem.dataset.quizId;
            const qIndex = quizItem.dataset.questionIndex;

            if (quizId === 'simuladoGeral') {
                if(userProgress.quizResults?.simuladoGeral?.finalized) return;
                
                quizItem.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('simulado-selected'));
                e.target.classList.add('simulado-selected');

                if (!userProgress.quizResults) userProgress.quizResults = {};
                if (!userProgress.quizResults[quizId]) userProgress.quizResults[quizId] = {};
                userProgress.quizResults[quizId][qIndex] = { userAnswer: e.target.textContent };
                await saveUserProgress();
            } else {
                if (quizItem.querySelector('.answered')) return;
                const correctAnswer = studyData.quizzes[quizId].questions[qIndex].answer;
                const isCorrect = e.target.textContent === correctAnswer;
                
                if (!userProgress.quizResults) userProgress.quizResults = {};
                if (!userProgress.quizResults[quizId]) userProgress.quizResults[quizId] = {};
                userProgress.quizResults[quizId][qIndex] = { userAnswer: e.target.textContent, isCorrect };
                
                await saveUserProgress();
                loadQuizState(quizItem.closest('.modal'));
                updatePerformancePanel();
            }
        }
    });
</script>

</body>
</html>


